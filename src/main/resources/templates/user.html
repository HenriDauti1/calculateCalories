<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calorie Tracker Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="/static/css/user.css" rel="stylesheet">
</head>
<body>
<div class="dashboard">
  <div class="sidebar">
    <h2>Calorie Tracker</h2>
    <ul class="sidebar-menu">
      <li onclick="showSection('dashboard')" class="active">
        <i class="fas fa-home"></i> Dashboard
      </li>
      <li onclick="showSection('add-calories')">
        <i class="fas fa-plus"></i> Add Calories
      </li>
      <li onclick="showSection('weekly-report')">
        <i class="fas fa-chart-bar"></i> Weekly Report
      </li>
      <li onclick="showSection('custom-period')">
        <i class="fas fa-calendar"></i> Custom Period
      </li>
    </ul>
  </div>
  <div class="main-content">
    <div id="dashboard-section" class="content-section active">
      <div class="header">
        <h1>Dashboard Overview</h1>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div>Today's Calories</div>
          <div class="stat-value">1,850</div>
        </div>
        <div class="stat-card">
          <div>Weekly Average</div>
          <div class="stat-value">2,200</div>
        </div>
        <div class="stat-card">
          <div>Monthly Spending</div>
          <div class="stat-value">€580</div>
        </div>
      </div>
      <div class="card">
        <canvas id="dashboardChart"></canvas>
      </div>

      <!--Shtimi i kalorive  -->
    </div>
    <div id="add-calories-section" class="content-section">
      <div class="header">
        <h1>Add Calories</h1>
        <button class="add-btn" onclick="openModal()">Add Entry</button>
      </div>
      <div class="card">
        <div id="foodEntries"></div>
      </div>
    </div>

    <!-- Raporti javor i kalorive te marra -->
    <div id="weekly-report-section" class="content-section">
      <div class="header">
        <h1>Weekly Report</h1>
      </div>
      <div class="card">
        <canvas id="weeklyChart"></canvas>
      </div>
    </div>

    <!-- Analizimi i periudhes kohore te kerkuar -->
    <div id="custom-period-section" class="content-section">
      <div class="header">
        <h1>Custom Period Analysis</h1>
      </div>
      <div class="date-range">
       From<input  type="date" id="startDate">
        To<input type="date" id="endDate">
        <button class="add-btn" onclick="filterByDate()">Filter</button>
      </div>
      <div class="card">
        <canvas id="customChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Shtimi i ushqimeve -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h2>Add Food Entry</h2>
    <form id="foodForm">
      <div class="form-group">
        <label>Food Name</label>
        <input type="text" id="foodName" required>
      </div>
      <div class="form-group">
        <label>Calories</label>
        <input type="number" id="calories" required>
      </div>
      <div class="form-group">
        <label>Price (€)</label>
        <input type="number" id="price" step="0.01" required>
      </div>
      <button type="submit" class="add-btn">Save</button>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
  // Navigimi
  function showSection(sectionId) {
    document.querySelectorAll('.content-section').forEach(section => {
      section.classList.remove('active');
    });
    document.getElementById(sectionId + '-section').classList.add('active');
  }

  function openModal() {
    document.getElementById('modal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('modal').style.display = 'none';
  }


  //Shtimi i ushqimeve
  document.getElementById('foodForm').onsubmit = function(e) {
    e.preventDefault();
    const entry = {
      name: document.getElementById('foodName').value,
      calories: parseInt(document.getElementById('calories').value),
      price: parseFloat(document.getElementById('price').value),
      date: new Date()
    };
    updateFoodEntries(entry);
    closeModal();
    this.reset();
    const username = 'username';
    fetch(`http://localhost:8080/calories/add?username=${username}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Basic ' + btoa("Admin" + ':' + "Test123!")
      },
      body: JSON.stringify(entry)
    })
            .then(response => response.json())
            .then(data => {
              updateFoodEntries(data);
              closeModal();
              document.getElementById('foodForm').reset();
            })
            .catch(error => {
              console.error('Error adding food entry:', error);
            });
  };
  function filterByDate() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    // Implement date filtering logic here
    const customCtx = document.getElementById('customChart').getContext('2d');
    new Chart(customCtx, {
      type: 'line',
      data: {
        labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
        datasets: [{
          label: 'Calories',
          data: [2400, 2200, 2600, 2300, 2500],
          borderColor: '#3b82f6',
          tension: 0.1
        }]
      }
    });
  }
  window.onclick = function(event) {
    if (event.target == document.getElementById('modal')) {
      closeModal();
    }
  }
  function updateFoodEntries(entry) {
    const container = document.getElementById('foodEntries');
    const div = document.createElement('div');
    div.className = 'food-entry';
    div.innerHTML = `
        <div>
            <div>${entry.name}</div>
            <div style="color: #666; font-size: 0.9em">
                ${new Date(entry.date).toLocaleDateString()}
            </div>
        </div>
        <div>
            <div>${entry.calories} cal</div>
            <div style="color: #666; font-size: 0.9em">
                €${entry.price.toFixed(2)}
            </div>
        </div>
    `;
    container.insertBefore(div, container.firstChild);
  }
  function getCaloriesData(username) {
    fetch(`http://localhost:8080/calories/user/${username}`, {
      method: 'GET',
      headers: {
        'Authorization': 'Basic ' + btoa("Admin" + ':' + "Test123!")
      }
    })
            .then(response => response.json())
            .then(data => {
              updateDashboardStats(data);
            })
            .catch(error => {
              console.error('Error fetching calories data:', error);
            });
  }
  // Grafiket
  const dashboardCtx = document.getElementById('dashboardChart').getContext('2d');
  new Chart(dashboardCtx, {
    type: 'line',
    data: {
      labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      datasets: [{
        label: 'Daily Calories',
        data: [2300, 2600, 2100, 2800, 2400, 2200, 2700],
        borderColor: '#2c314a',
        tension: 0.2
      }]
    },
    options: {
      responsive: true
    }
  });
  function updateDashboardStats(data) {
    const todayCalories = data.find(entry => new Date(entry.dateTime).toLocaleDateString() === new Date().toLocaleDateString());
    const weeklyCalories = data.filter(entry => new Date(entry.dateTime) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000));

    const dailyCalories = todayCalories ? todayCalories.calories : 0;
    const weeklyAverage = weeklyCalories.length ? weeklyCalories.reduce((acc, entry) => acc + entry.calories, 0) / weeklyCalories.length : 0;


    document.querySelector('.stat-value').innerText = `${dailyCalories} cal`;
    document.querySelectorAll('.stat-value')[1].innerText = `${weeklyAverage.toFixed(0)} cal`;
  }

  function getWeeklyCaloriesReport(username) {
    fetch(`http://localhost:8080/calories/user/${username}/total-calories-week`, {
      method: 'GET',
      headers: {
        'Authorization': 'Basic ' + btoa("Admin" + ':' + "Test123!")
      }
    })
            .then(response => response.json())
            .then(data => {
              updateWeeklyReport(data);  // Update the weekly report
            })
            .catch(error => {
              console.error('Error fetching weekly report:', error);
            });
  }

  function updateWeeklyReport(data) {
    const labels = Object.keys(data);
    const caloriesData = Object.values(data);

    const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
    new Chart(weeklyCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Calories',
          data: caloriesData,
          backgroundColor: '#493333'
        }]
      }
    });
  }

</script>
</body>
</html>